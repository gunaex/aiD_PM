<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resource DNA | aiD_PM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .sidebar-item-active {
            border-right: 4px solid #3b82f6;
            background: #1e293b;
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-100 font-sans h-screen overflow-hidden">
    <div class="flex h-full">
        <!-- Sidebar -->
        <aside class="w-64 bg-slate-950 text-slate-400 flex flex-col border-r border-slate-800">
            <div class="p-6 text-white font-bold text-xl tracking-tight border-b border-slate-800">
                aiD_PM <span class="text-blue-500">System</span>
            </div>
            <nav class="flex-1 mt-4 overflow-y-auto">
                <a href="/"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Dashboard</a>
                <a href="/projects/list"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Projects</a>
                <a href="/kanban"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Kanban</a>
                <a href="/tracking"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Tracking</a>
                <a href="/calendar-grid"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Calendar</a>

                <div class="px-6 py-2 mt-4 mb-2 border-t border-slate-700"></div>
                <a href="/management-control"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Control
                    Center</a><a href="/phases"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Phases</a>
                <a href="/functions"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Functions/Req</a>
                <a href="/resources"
                    class="sidebar-item-active flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Resources
                    ðŸ‘¤</a>
                <a href="/issues"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Issues</a>
            </nav>
            <div class="p-4 border-t border-slate-800 text-xs text-slate-500 text-center">
                v1.5 AI Powered
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-8 bg-slate-50 min-h-full">
            <div class="mb-8">
                <h1 class="text-2xl font-bold text-slate-800">Resource DNA Management</h1>
                <p class="text-slate-500 text-sm">Register team members and define their performance characteristics</p>
            </div>

            <!-- Add Resource Form -->
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm mb-8">
                <h3 class="text-lg font-bold mb-4 text-slate-800">Register Team DNA</h3>
                <form action="/resources/add" method="POST" onsubmit="prepareSkills()">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Left Column: Basic Info -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">Full Name</label>
                                <input type="text" name="full_name" placeholder="e.g. Somchai Jaidee"
                                    class="w-full text-slate-900 border border-slate-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    required>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Nickname</label>
                                    <input type="text" name="nickname" placeholder="e.g. Chai"
                                        class="w-full text-slate-900 border border-slate-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Position</label>
                                    <select name="position"
                                        class="w-full text-slate-900 border border-slate-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Select Position</option>
                                        <option value="Dev">Developer</option>
                                        <option value="SA">System Analyst</option>
                                        <option value="Tester">Tester</option>
                                        <option value="PM">Project Manager</option>
                                        <option value="BA">Business Analyst</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">Company</label>
                                <input type="text" name="company" placeholder="e.g. Outsourcing Co., Ltd."
                                    class="w-full text-slate-900 border border-slate-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Speed (1-10)</label>
                                    <input type="number" name="speed" min="1" max="10" value="5"
                                        class="w-full text-slate-900 border border-slate-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Quality (1-10)</label>
                                    <input type="number" name="quality" min="1" max="10" value="5"
                                        class="w-full text-slate-900 border border-slate-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Skills & Comment -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">Skills</label>
                                <div class="bg-slate-50 p-3 rounded border border-slate-200 mb-2">
                                    <div id="skills-list" class="flex flex-wrap gap-2 mb-2">
                                        <!-- Skills will be added here -->
                                    </div>
                                    <div class="flex gap-2">
                                        <input type="text" id="new-skill-name" placeholder="Skill (e.g. Python)"
                                            class="flex-1 text-xs text-slate-900 border border-slate-300 p-1 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <input type="number" id="new-skill-level" min="1" max="10" placeholder="Lvl"
                                            class="w-16 text-xs text-slate-900 border border-slate-300 p-1 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <button type="button" onclick="addSkill()"
                                            class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-700">
                                            Add
                                        </button>
                                    </div>
                                </div>
                                <input type="hidden" name="skills_json" id="skills_json">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">Comment / Notes</label>
                                <textarea name="comment" rows="3" placeholder="Additional details..."
                                    class="w-full text-slate-900 border border-slate-300 p-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end">
                        <button type="submit"
                            class="bg-slate-900 hover:bg-slate-800 text-white px-6 py-2 rounded font-medium transition shadow-lg">
                            Save Resource
                        </button>
                    </div>
                </form>
            </div>

            <!-- Resources List -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="p-6 border-b border-slate-100">
                    <h3 class="font-bold text-slate-800">Current Team Members</h3>
                </div>
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold">
                        <tr>
                            <th class="px-6 py-4">Profile <span
                                    class="text-[10px] lowercase font-normal text-slate-400">(Double-click to
                                    edit)</span></th>
                            <th class="px-6 py-4">Company</th>
                            <th class="px-6 py-4">Skills</th>
                            <th class="px-6 py-4">Performance</th>
                            <th class="px-6 py-4">Status</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {% for resource in resources %}
                        <tr class="hover:bg-slate-50 transition cursor-pointer"
                            ondblclick="openEditResourceModal({{ resource.id }}, '{{ resource.full_name | replace("'", "\\'") }}', '{{ resource.nickname | replace("'", "\\'") }}', '{{ resource.position }}', '{{ resource.company | replace("'", "\\'") if resource.company else '' }}', {{ resource.speed_score }}, {{ resource.quality_score }}, '{{ resource.skills | replace("'", "\\'") if resource.skills else '{}' }}', '{{ resource.comment | replace("'", "\\'") if resource.comment else '' }}')">
                            <td class="px-6 py-4">
                                <div>
                                    <div class="font-bold text-slate-800">{{ resource.full_name }}</div>
                                    <div class="text-xs text-slate-500">
                                        {{ resource.nickname }} â€¢ <span class="font-semibold text-blue-600">{{
                                            resource.position }}</span>
                                    </div>
                                    {% if resource.comment %}
                                    <div class="text-xs text-slate-400 italic mt-1 max-w-xs truncate"
                                        title="{{ resource.comment }}">
                                        "{{ resource.comment }}"
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4 text-sm text-slate-600">
                                {{ resource.company if resource.company else '-' }}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex flex-wrap gap-1 max-w-xs">
                                    {% if resource.skills %}
                                    {% set skills_dict = resource.skills | fromjson %}
                                    {% for skill, level in skills_dict.items() %}
                                    <span
                                        class="inline-flex items-center px-2 py-0.5 bg-slate-100 text-slate-700 rounded text-xs font-medium border border-slate-200">
                                        {{ skill }} <span class="ml-1 text-[10px] bg-slate-200 px-1 rounded-full">{{
                                            level
                                            }}</span>
                                    </span>
                                    {% endfor %}
                                    {% else %}
                                    <span class="text-xs text-slate-400">No skills listed</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="space-y-1 w-32">
                                    <div class="flex items-center justify-between text-xs">
                                        <span class="text-slate-500">Speed</span>
                                        <span class="font-bold">{{ resource.speed_score }}</span>
                                    </div>
                                    <div class="bg-slate-100 rounded-full h-1.5 w-full">
                                        <div class="bg-green-500 h-1.5 rounded-full"
                                            style="width: {{ (resource.speed_score / 10 * 100) }}%"></div>
                                    </div>
                                    <div class="flex items-center justify-between text-xs">
                                        <span class="text-slate-500">Quality</span>
                                        <span class="font-bold">{{ resource.quality_score }}</span>
                                    </div>
                                    <div class="bg-slate-100 rounded-full h-1.5 w-full">
                                        <div class="bg-blue-500 h-1.5 rounded-full"
                                            style="width: {{ (resource.quality_score / 10 * 100) }}%"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                {% if resource.is_active %}
                                <span
                                    class="px-2 py-1 bg-green-50 text-green-600 rounded text-xs font-bold">ACTIVE</span>
                                {% else %}
                                <span class="px-2 py-1 bg-red-50 text-red-600 rounded text-xs font-bold">INACTIVE</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Edit Resource Modal -->
    <div id="editResourceModal"
        class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden border border-slate-200">
            <div class="bg-slate-900 px-6 py-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-lg">Edit Team DNA</h3>
                <button onclick="closeEditModal()" class="text-slate-400 hover:text-white text-xl">Ã—</button>
            </div>
            <form id="editResourceForm" method="POST" onsubmit="prepareEditSkills()" class="p-6 space-y-6">
                <input type="hidden" name="skills_json" id="edit_skills_json">

                <div class="grid grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1 uppercase tracking-wider">Full
                                Name</label>
                            <input type="text" name="full_name" id="edit_full_name" required
                                class="w-full text-slate-900 border border-slate-300 p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-700 mb-1 uppercase tracking-wider">Nickname</label>
                                <input type="text" name="nickname" id="edit_nickname" required
                                    class="w-full text-slate-900 border border-slate-300 p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-700 mb-1 uppercase tracking-wider">Position</label>
                                <select name="position" id="edit_position"
                                    class="w-full text-slate-900 border border-slate-300 p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="Dev">Developer</option>
                                    <option value="SA">System Analyst</option>
                                    <option value="Tester">Tester</option>
                                    <option value="PM">Project Manager</option>
                                    <option value="BA">Business Analyst</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label
                                class="block text-xs font-bold text-slate-700 mb-1 uppercase tracking-wider">Company</label>
                            <input type="text" name="company" id="edit_company"
                                class="w-full text-slate-900 border border-slate-300 p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-700 mb-1 uppercase tracking-wider">Speed
                                    (1-10)</label>
                                <input type="number" name="speed" id="edit_speed" min="1" max="10"
                                    class="w-full text-slate-900 border border-slate-300 p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-700 mb-1 uppercase tracking-wider">Quality
                                    (1-10)</label>
                                <input type="number" name="quality" id="edit_quality" min="1" max="10"
                                    class="w-full text-slate-900 border border-slate-300 p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label
                                class="block text-xs font-bold text-slate-700 mb-1 uppercase tracking-wider">Skills</label>
                            <div class="bg-slate-50 p-3 rounded border border-slate-200 min-h-[100px]">
                                <div id="edit-skills-list" class="flex flex-wrap gap-2 mb-3"></div>
                                <div class="flex gap-2">
                                    <input type="text" id="edit-new-skill-name" placeholder="Skill"
                                        class="flex-1 text-xs text-slate-900 border border-slate-300 p-1 rounded">
                                    <input type="number" id="edit-new-skill-level" min="1" max="10" placeholder="Lvl"
                                        class="w-12 text-xs text-slate-900 border border-slate-300 p-1 rounded">
                                    <button type="button" onclick="addEditSkill()"
                                        class="bg-blue-600 text-white px-2 py-1 rounded text-[10px] font-bold">Add</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label
                                class="block text-xs font-bold text-slate-700 mb-1 uppercase tracking-wider">Comment</label>
                            <textarea name="comment" id="edit_comment" rows="3"
                                class="w-full text-slate-900 border border-slate-300 p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t border-slate-100">
                    <button type="button" onclick="closeEditModal()"
                        class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">Cancel</button>
                    <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-bold shadow-lg shadow-blue-500/30 transition">
                        Update Resource DNA
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let skills = {};
        let editSkills = {};

        function addSkill() {
            const nameInput = document.getElementById('new-skill-name');
            const levelInput = document.getElementById('new-skill-level');
            const name = nameInput.value.trim();
            const level = parseInt(levelInput.value);

            if (name && level >= 1 && level <= 10) {
                skills[name] = level;
                renderSkills();
                nameInput.value = '';
                levelInput.value = '';
                nameInput.focus();
            }
        }

        function removeSkill(name) {
            delete skills[name];
            renderSkills();
        }

        function renderSkills() {
            const container = document.getElementById('skills-list');
            container.innerHTML = '';
            for (const [name, level] of Object.entries(skills)) {
                const tag = document.createElement('div');
                tag.className = 'inline-flex items-center px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs font-bold border border-blue-100';
                tag.innerHTML = `${name} <span class="ml-1 bg-blue-200 px-1.5 rounded-full text-[10px]">${level}</span>
                    <button type="button" onclick="removeSkill('${name}')" class="ml-2 text-blue-400 hover:text-red-500">Ã—</button>`;
                container.appendChild(tag);
            }
        }

        function prepareSkills() {
            document.getElementById('skills_json').value = JSON.stringify(skills);
            return true;
        }

        // Edit Modal Logic
        const editModal = document.getElementById('editResourceModal');
        const editForm = document.getElementById('editResourceForm');

        function openEditResourceModal(id, name, nickname, position, company, speed, quality, skillsJson, comment) {
            editForm.action = `/resources/${id}/update`;
            document.getElementById('edit_full_name').value = name;
            document.getElementById('edit_nickname').value = nickname;
            document.getElementById('edit_position').value = position;
            document.getElementById('edit_company').value = company;
            document.getElementById('edit_speed').value = speed;
            document.getElementById('edit_quality').value = quality;
            document.getElementById('edit_comment').value = comment;

            try {
                editSkills = JSON.parse(skillsJson.replace(/&quot;/g, '"'));
            } catch (e) {
                editSkills = {};
            }
            renderEditSkills();

            editModal.classList.remove('hidden');
            editModal.classList.add('flex');
        }

        function closeEditModal() {
            editModal.classList.add('hidden');
            editModal.classList.remove('flex');
        }

        function addEditSkill() {
            const nameInput = document.getElementById('edit-new-skill-name');
            const levelInput = document.getElementById('edit-new-skill-level');
            const name = nameInput.value.trim();
            const level = parseInt(levelInput.value);
            if (name && level) {
                editSkills[name] = level;
                renderEditSkills();
                nameInput.value = '';
                levelInput.value = '';
            }
        }

        function removeEditSkill(name) {
            delete editSkills[name];
            renderEditSkills();
        }

        function renderEditSkills() {
            const container = document.getElementById('edit-skills-list');
            container.innerHTML = '';
            for (const [name, level] of Object.entries(editSkills)) {
                const tag = document.createElement('div');
                tag.className = 'inline-flex items-center px-2 py-1 bg-slate-100 text-slate-700 rounded text-[10px] font-bold border border-slate-200';
                tag.innerHTML = `${name} <span class="ml-1 bg-slate-200 px-1.5 rounded-full">${level}</span>
                    <button type="button" onclick="removeEditSkill('${name}')" class="ml-2 text-slate-400 hover:text-red-500">Ã—</button>`;
                container.appendChild(tag);
            }
        }

        function prepareEditSkills() {
            document.getElementById('edit_skills_json').value = JSON.stringify(editSkills);
            return true;
        }

        editModal.addEventListener('click', (e) => { if (e.target === editModal) closeEditModal(); });
    </script>
</body>

</html>