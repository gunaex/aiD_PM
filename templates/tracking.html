<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracking & Progress | aiD_PM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .sidebar-item-active {
            border-right: 4px solid #3b82f6;
            background: #1e293b;
        }

        .hierarchy-line {
            position: relative;
        }

        .hierarchy-line::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 50%;
            width: 15px;
            height: 1px;
            background: #cbd5e1;
        }

        .hierarchy-line::after {
            content: '';
            position: absolute;
            left: -20px;
            top: 0;
            width: 1px;
            height: 100%;
            background: #cbd5e1;
        }

        .hierarchy-line:last-child::after {
            height: 50%;
        }

        .timeline-container {
            position: relative;
            background: #f8fafc;
            border-left: 1px solid #e2e8f0;
        }

        .timeline-bar {
            position: absolute;
            height: 8px;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .today-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ef4444;
            z-index: 10;
        }

        .today-label {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ef4444;
            color: white;
            font-size: 9px;
            font-weight: bold;
            padding: 2px 4px;
            border-radius: 2px;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-100 font-sans h-screen overflow-hidden">
    <div class="flex h-full">
        <!-- Sidebar -->
        <aside class="w-64 bg-slate-950 text-slate-400 flex flex-col border-r border-slate-800">
            <div
                class="p-6 text-white font-bold text-xl tracking-tight border-b border-slate-800 flex items-center gap-2">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-sm">ai</div>
                aiD_PM <span class="text-blue-500">System</span>
            </div>
            <nav class="flex-1 mt-4 overflow-y-auto">
                <a href="/"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Dashboard</a>
                <a href="/projects/list"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Projects</a>
                <a href="/kanban"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Kanban</a>
                <a href="/tracking"
                    class="flex items-center px-6 py-3 sidebar-item-active text-white hover:bg-slate-900 transition">Tracking</a>
                <a href="/calendar-grid"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Calendar</a>

                <div class="px-6 py-2 mt-4 mb-2 border-t border-slate-700"></div>
                <a href="/management-control"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Control
                    Center</a>
                <a href="/phases"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Phases</a>
                <a href="/functions"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Functions/Req</a>
                <a href="/issues"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Issues</a>
            </nav>
            <div class="p-4 border-t border-slate-800 text-xs text-slate-600 text-center">
                v1.5 AI Powered
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-hidden flex flex-col bg-slate-50">
            <!-- Header -->
            <div class="p-8 pb-4">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <nav class="text-xs text-slate-400 mb-2">
                            <a href="/" class="hover:text-blue-600">Home</a> /
                            <span class="text-slate-600">Project Tracking</span>
                        </nav>
                        <h1 class="text-3xl font-extrabold text-slate-900 flex items-center gap-3">
                            ðŸ“Š Project Tracking & Progress
                            {% if selected_project %}
                            <span class="text-lg font-medium text-slate-400">| {{ selected_project.name }}</span>
                            {% endif %}
                        </h1>
                    </div>

                    <div class="flex gap-3">
                        <select onchange="window.location.href='/tracking?project_id=' + this.value"
                            class="bg-white border border-slate-200 text-slate-700 text-sm rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 outline-none shadow-sm">
                            <option value="">Select Project to Track...</option>
                            {% for p in projects %}
                            <option value="{{ p.id }}" {% if selected_project_id==p.id %}selected{% endif %}>{{ p.name
                                }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                {% if selected_project %}
                <!-- Summary Bar -->
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Methodology
                        </div>
                        <div class="text-sm font-bold text-slate-800">{{ selected_project.methodology }}</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Status</div>
                        <div class="flex items-center gap-2">
                            <span
                                class="w-2 h-2 rounded-full {% if selected_project.is_recovery_mode %}bg-red-500{% else %}bg-green-500{% endif %}"></span>
                            <span class="text-sm font-bold text-slate-800">{% if selected_project.is_recovery_mode
                                %}Recovery{% else %}On Track{% endif %}</span>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm col-span-2">
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Cumulative View
                        </div>
                        <div class="flex gap-1">
                            <button id="view-weekly"
                                class="px-3 py-1 bg-blue-600 text-white text-[10px] font-bold rounded-md">Weekly</button>
                            <button id="view-monthly"
                                class="px-3 py-1 bg-slate-100 text-slate-500 text-[10px] font-bold rounded-md hover:bg-slate-200">Monthly</button>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-hidden px-8 pb-8">
                {% if selected_project_id %}
                <div
                    class="bg-white rounded-2xl border border-slate-200 shadow-lg h-full flex flex-col overflow-hidden">
                    <!-- Tracking Header -->
                    <div
                        class="flex bg-slate-50 border-b border-slate-200 text-[11px] font-bold text-slate-500 uppercase tracking-wider">
                        <div class="w-1/3 px-6 py-4">Requirement / Task Structure</div>
                        <div class="w-32 px-4 py-4 text-center">Resources</div>
                        <div class="w-40 px-4 py-4 text-center">Effort (Est/Act)</div>
                        <div class="flex-1 px-4 py-4 text-center relative">
                            Timeline & Progress
                            <div id="timeline-header"
                                class="absolute inset-x-0 bottom-0 flex border-t border-slate-200 bg-white">
                                <!-- Months will be injected here -->
                            </div>
                        </div>
                    </div>

                    <!-- Tracking Body -->
                    <div id="tracking-body" class="flex-1 overflow-y-auto scrollbar-hide divide-y divide-slate-100">
                        <!-- Hierarchy rows will be injected here -->
                    </div>
                </div>
                {% else %}
                <div
                    class="h-full flex flex-col items-center justify-center bg-white rounded-2xl border border-dashed border-slate-300">
                    <div class="text-6xl mb-6">ðŸ”­</div>
                    <h2 class="text-xl font-bold text-slate-800 mb-2">No Project Selected</h2>
                    <p class="text-slate-500 mb-8 max-w-sm text-center">Please select a project from the dropdown above
                        to view the detailed tracking hierarchy and timeline.</p>
                </div>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- Templates & Scripts -->
    <script>
        const hierarchy = {{ hierarchy_json| safe }};
        const dateRange = {{ date_range_json| safe }};
        const body = document.getElementById('tracking-body');
        const timelineHeader = document.getElementById('timeline-header');

        function renderTimelineHeader() {
            if (!dateRange.start) return;
            const start = new Date(dateRange.start);
            const end = new Date(dateRange.end);
            const totalDays = (end - start) / (1000 * 60 * 60 * 24);

            // Generate months
            let curr = new Date(start);
            curr.setDate(1);
            let html = '';
            while (curr < end) {
                const monthStart = new Date(curr);
                const monthEnd = new Date(curr.getFullYear(), curr.getMonth() + 1, 1);
                const actualStart = monthStart < start ? start : monthStart;
                const actualEnd = monthEnd > end ? end : monthEnd;
                const daysInMonth = (actualEnd - actualStart) / (1000 * 60 * 60 * 24);
                const width = (daysInMonth / totalDays) * 100;

                if (width > 0) {
                    html += `
                        <div class="border-r border-slate-100 py-1 text-[9px] text-center overflow-hidden whitespace-nowrap" style="width: ${width}%">
                            ${curr.toLocaleString('default', { month: 'short' })} ${curr.getFullYear()}
                        </div>
                    `;
                }
                curr.setMonth(curr.getMonth() + 1);
            }
            timelineHeader.innerHTML = html;
        }

        function getProgressColor(p) {
            if (p >= 100) return 'bg-green-500';
            if (p >= 50) return 'bg-blue-500';
            if (p > 0) return 'bg-yellow-500';
            return 'bg-slate-300';
        }

        function renderNode(node, depth = 0) {
            const indent = depth * 24;
            const isTask = node.type === 'task';
            const start = dateRange.start ? new Date(dateRange.start) : null;
            const end = dateRange.end ? new Date(dateRange.end) : null;
            const totalDays = (end - start) / (1000 * 60 * 60 * 24);

            let timelineBar = '';
            if (node.planned_start && node.planned_end && start) {
                const nodeStart = new Date(node.planned_start);
                const nodeEnd = new Date(node.planned_end);
                const left = Math.max(0, (nodeStart - start) / (1000 * 60 * 60 * 24) / totalDays * 100);
                const width = Math.min(100 - left, (nodeEnd - nodeStart) / (1000 * 60 * 60 * 24) / totalDays * 100);
                const color = isTask ? 'bg-blue-400' : 'bg-green-400';

                timelineBar = `<div class="timeline-bar ${color} shadow-sm" style="left: ${left}%; width: ${width}%"></div>`;
            }

            const row = document.createElement('div');
            row.className = `flex hover:bg-slate-50 transition-colors group cursor-pointer ${node.type === 'function' ? 'bg-white' : ''}`;
            row.innerHTML = `
                <div class="w-1/3 px-6 py-4 flex items-center min-w-0">
                    <div style="width: ${indent}px" class="flex-shrink-0"></div>
                    <div class="flex items-center gap-3 min-w-0 ${depth > 0 && !isTask ? 'hierarchy-line' : ''}">
                        <div class="w-6 h-6 rounded flex items-center justify-center text-xs flex-shrink-0 
                                    ${isTask ? 'bg-blue-50 text-blue-600 font-bold' : 'bg-slate-100 text-slate-500'}">
                            ${isTask ? 'T' : (node.type === 'group' ? 'G' : 'R')}
                        </div>
                        <div class="truncate">
                            <div class="text-[13px] font-bold ${isTask ? 'text-slate-700' : 'text-slate-900'}">${node.name}</div>
                            ${node.code ? `<div class="text-[9px] font-mono text-slate-400 uppercase">${node.code}</div>` : ''}
                        </div>
                    </div>
                </div>
                <div class="w-32 px-4 py-4 flex items-center justify-center">
                    ${node.assigned_to ? `<span class="px-2 py-0.5 bg-slate-100 rounded text-[10px] font-bold text-slate-600">${node.assigned_to}</span>` : '-'}
                </div>
                <div class="w-40 px-4 py-4 flex flex-col items-center justify-center">
                    <div class="text-[11px] font-bold text-slate-700">
                        ${node.actual_hours !== undefined ? `${node.actual_hours}h / ${node.estimated_hours}h` : '-'}
                    </div>
                    <div class="w-full bg-slate-100 h-1 rounded-full mt-1.5 overflow-hidden">
                        <div class="h-full ${getProgressColor(node.progress)}" style="width: ${node.progress}%"></div>
                    </div>
                </div>
                <div class="flex-1 px-4 py-4 relative timeline-container">
                    ${timelineBar}
                    <!-- Today Marker -->
                    ${depth === 0 && start ? `<div class="today-line" style="left: ${Math.max(0, Math.min(100, (new Date() - start) / (1000 * 60 * 60 * 24) / totalDays * 100))}%"></div>` : ''}
                </div>
            `;
            body.appendChild(row);

            if (node.children) {
                node.children.forEach(child => renderNode(child, depth + 1));
            }
        }

        if (hierarchy.length > 0) {
            renderTimelineHeader();
            hierarchy.forEach(node => renderNode(node));
        }

    </script>
</body>

</html>