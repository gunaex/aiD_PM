<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Workload | aiD_PM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .sidebar-item-active {
            border-right: 4px solid #3b82f6;
            background: #1e293b;
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-100 font-sans h-screen overflow-hidden">
    <div class="flex h-full">
        <!-- Sidebar -->
        <aside class="w-64 bg-slate-950 text-slate-400 flex flex-col border-r border-slate-800">
            <div class="p-6 text-white font-bold text-xl tracking-tight border-b border-slate-800">
                aiD_PM <span class="text-blue-500">System</span>
            </div>
            <nav class="flex-1 mt-4 overflow-y-auto">
                <a href="/"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Dashboard</a>
                <a href="/projects/list"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Projects</a>
                <a href="/kanban"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Kanban</a>
                <a href="/tracking"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Tracking</a>
                <a href="/calendar-grid"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Calendar</a>

                <div class="px-6 py-2 mt-4 mb-2 border-t border-slate-700"></div>
                <a href="/management-control"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Control
                    Center</a><a href="/phases"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Phases</a>
                <a href="/functions"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Functions/Req</a>
                <a href="/issues"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Issues</a>
            </nav>
            <div class="p-4 border-t border-slate-800 text-xs text-slate-500 text-center">
                v1.5 AI Powered
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-8 bg-slate-50 min-h-full relative">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-2xl font-bold text-slate-800">Team Workload</h1>
                <p class="text-slate-500 text-sm">Monitor team capacity and task distribution</p>
            </div>

            <!-- Team Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <div class="text-slate-500 text-xs font-bold uppercase mb-1">Total Resources</div>
                    <div class="text-3xl font-bold">{{ resources|length }}</div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm border-l-4 border-blue-500">
                    <div class="text-slate-500 text-xs font-bold uppercase mb-1">Active Tasks</div>
                    <div class="text-3xl font-bold text-blue-600">{{ workload_data|map(attribute='task_count')|sum }}
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm border-l-4 border-green-500">
                    <div class="text-slate-500 text-xs font-bold uppercase mb-1">Available</div>
                    <div class="text-3xl font-bold text-green-600">{{ workload_data|selectattr('task_count', 'equalto',
                        0)|list|length }}</div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm border-l-4 border-red-500">
                    <div class="text-slate-500 text-xs font-bold uppercase mb-1">Overloaded</div>
                    <div class="text-3xl font-bold text-red-600">{{ workload_data|selectattr('task_count', 'gt',
                        5)|list|length }}</div>
                </div>
            </div>

            <!-- Workload Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                {% for item in workload_data %}
                <div
                    class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden 
                            {% if item.task_count > 5 %}border-l-4 border-red-500{% elif item.task_count == 0 %}border-l-4 border-green-500{% else %}border-l-4 border-blue-500{% endif %}">
                    <!-- Resource Header -->
                    <div class="p-6 bg-gradient-to-br from-slate-50 to-white">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-lg">
                                    {{ item.resource.full_name[0] }}{{ item.resource.nickname[0] if
                                    item.resource.nickname else '' }}
                                </div>
                                <div>
                                    <h3 class="font-bold text-slate-800">{{ item.resource.full_name }}</h3>
                                    <p class="text-xs text-slate-500">{{ item.resource.nickname if
                                        item.resource.nickname else 'No nickname' }} ‚Ä¢ {{ item.resource.position if
                                        item.resource.position else 'No position' }}</p>
                                </div>
                            </div>
                            {% if item.task_count > 5 %}
                            <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-bold">OVERLOAD</span>
                            {% elif item.task_count == 0 %}
                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-bold">FREE</span>
                            {% else %}
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-bold">ACTIVE</span>
                            {% endif %}
                        </div>

                        <!-- Skills -->
                        {% if item.resource.skills %}
                        <div class="flex flex-wrap gap-1 mb-3">
                            {% set skills_dict = item.resource.skills | fromjson %}
                            {% for skill, level in skills_dict.items() %}
                            <span class="px-2 py-0.5 bg-slate-100 text-slate-700 text-xs rounded">
                                {{ skill }} ({{ level }})
                            </span>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Capacity -->
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-slate-600">Workload Capacity</span>
                            <span
                                class="font-bold {% if item.task_count > 5 %}text-red-600{% elif item.task_count > 3 %}text-yellow-600{% else %}text-green-600{% endif %}">
                                {{ item.task_count }}/8 tasks
                            </span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2 mt-2">
                            <div class="{% if item.task_count > 5 %}bg-red-500{% elif item.task_count > 3 %}bg-yellow-500{% else %}bg-green-500{% endif %} h-2 rounded-full transition-all"
                                style="width: {% if (item.task_count / 8 * 100) > 100 %}100{% else %}{{ item.task_count / 8 * 100 }}{% endif %}%">
                            </div>
                        </div>

                        <!-- Progress Summary -->
                        <div class="mt-3 grid grid-cols-3 gap-2 text-center">
                            <div class="bg-slate-50 rounded p-2">
                                <div class="text-xs text-slate-500">Todo</div>
                                <div class="text-lg font-bold text-slate-700">{{ item.todo_count }}</div>
                            </div>
                            <div class="bg-blue-50 rounded p-2">
                                <div class="text-xs text-blue-600">Active</div>
                                <div class="text-lg font-bold text-blue-700">{{ item.in_progress_count }}</div>
                            </div>
                            <div class="bg-green-50 rounded p-2">
                                <div class="text-xs text-green-600">Done</div>
                                <div class="text-lg font-bold text-green-700">{{ item.completed_count }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Tasks List -->
                    <div class="p-4 bg-slate-50 border-t border-slate-100">
                        <h4 class="text-xs font-bold text-slate-600 uppercase mb-3">Assigned Tasks ({{
                            item.tasks|length }})</h4>
                        {% if item.tasks|length > 0 %}
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            {% for task in item.tasks %}
                            <div onclick="openEditModal({{ task.id }}, '{{ task.task_name }}', '{{ task.task_type }}', {{ task.weight_score }}, {{ task.actual_progress }}, '{{ task.planned_start }}', '{{ task.planned_end }}', {{ task.project_id }}, {{ item.resource.id }})"
                                class="bg-white p-3 rounded border border-slate-200 hover:shadow-md hover:border-blue-300 transition cursor-pointer group relative">
                                <div class="flex items-start justify-between mb-1">
                                    <div class="text-xs font-semibold text-slate-800 flex-1">{{ task.task_name }}
                                    </div>
                                    <span
                                        class="px-1.5 py-0.5 bg-blue-100 text-blue-700 text-xs rounded font-bold ml-2">
                                        {{ task.task_type }}
                                    </span>
                                </div>
                                <div class="text-xs text-slate-500 mb-2">Project #{{ task.project_id }}</div>
                                <div class="flex items-center justify-between">
                                    <div class="flex-1 bg-slate-100 rounded-full h-1 mr-2">
                                        <div class="{% if task.actual_progress == 100 %}bg-green-500{% elif task.actual_progress >= 50 %}bg-blue-500{% elif task.actual_progress > 0 %}bg-yellow-500{% else %}bg-slate-300{% endif %} h-1 rounded-full"
                                            style="width: {{ task.actual_progress }}%"></div>
                                    </div>
                                    <span class="text-xs font-bold text-slate-600">{{ task.actual_progress }}%</span>
                                </div>
                                <div
                                    class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition text-slate-400">
                                    ‚úèÔ∏è
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4 text-xs text-slate-400">
                            No tasks assigned
                        </div>
                        {% endif %}
                    </div>

                    <!-- Actions -->
                    <div class="p-4 bg-white border-t border-slate-100">
                        <button onclick="openAssignModal({{ item.resource.id }})"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium py-2 rounded transition">
                            + Assign New Task
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>

            {% if workload_data|length == 0 %}
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-12 text-center">
                <div class="text-5xl mb-4">üë•</div>
                <h3 class="text-lg font-bold text-slate-700 mb-2">No Resources Yet</h3>
                <p class="text-slate-500 mb-6">Add team members to track their workload</p>
                <a href="/resources"
                    class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition">
                    Add Resources
                </a>
            </div>
            {% endif %}
        </main>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden">
            <div class="bg-slate-900 px-6 py-4 flex justify-between items-center">
                <h3 id="modalTitle" class="text-white font-bold text-lg">Assign Task</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white text-xl">√ó</button>
            </div>
            <form id="taskForm" method="POST" class="p-6 space-y-4">
                <input type="hidden" name="next_url" value="/workload">
                <input type="hidden" name="resource_ids" id="modalResourceId">

                <div>
                    <label class="block text-xs font-bold text-slate-700 mb-1 uppercase tracking-wider">Project</label>
                    <select name="project_id" id="modalProjectId" required
                        class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="">-- Select Project --</option>
                        {% for p in projects %}
                        <option value="{{ p.id }}">{{ p.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-700 mb-1 uppercase tracking-wider">Task
                        Name</label>
                    <input type="text" name="task_name" id="modalTaskName"
                        class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1 uppercase tracking-wider">Type</label>
                        <select name="task_type" id="modalTaskType"
                            class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                            <option value="Dev">Development</option>
                            <option value="Admin">Admin</option>
                            <option value="Procurement">Procurement</option>
                            <option value="Fix">Bug Fix</option>
                            <option value="Internal">Internal</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Weight</label>
                        <input type="number" step="0.1" name="weight_score" id="modalWeight" value="1.0"
                            class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Start Date</label>
                        <input type="date" name="planned_start" id="modalStart"
                            class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">End Date</label>
                        <input type="date" name="planned_end" id="modalEnd"
                            class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div id="progressField" class="hidden">
                    <label class="block text-xs font-bold text-slate-700 mb-1">Progress (%)</label>
                    <input type="range" name="actual_progress" id="modalProgress" min="0" max="100" value="0"
                        class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    <div class="text-right text-xs font-bold text-blue-600" id="progressValue">0%</div>
                </div>

                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" onclick="closeModal()"
                        class="px-4 py-2 border border-slate-300 rounded text-slate-700 text-sm font-medium hover:bg-slate-50">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700 shadow-sm">Save
                        Task</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const modal = document.getElementById('taskModal');
        const form = document.getElementById('taskForm');
        const title = document.getElementById('modalTitle');
        const progressField = document.getElementById('progressField');
        const progressInput = document.getElementById('modalProgress');
        const progressValue = document.getElementById('progressValue');

        progressInput.addEventListener('input', (e) => {
            progressValue.textContent = `${e.target.value}%`;
        });

        function openAssignModal(resourceId) {
            title.textContent = 'Assign New Task';
            form.action = '/tasks/create';
            form.reset();
            document.getElementById('modalResourceId').value = resourceId;
            document.getElementById('modalProjectId').readOnly = false; // Allow editing project ID for new task
            progressField.classList.add('hidden');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function openEditModal(id, name, type, weight, progress, start, end, projectId, resourceId) {
            title.textContent = 'Edit Task';
            form.action = `/tasks/${id}/edit`;

            document.getElementById('modalTaskName').value = name;
            document.getElementById('modalTaskType').value = type;
            document.getElementById('modalWeight').value = weight;
            document.getElementById('modalStart').value = start !== 'None' ? start : '';
            document.getElementById('modalEnd').value = end !== 'None' ? end : '';
            document.getElementById('modalProjectId').value = projectId;
            document.getElementById('modalResourceId').value = resourceId;

            // For edit, maybe we want to lock project ID? Or allow moving? Let's allow moving.
            // But we need to handle progress
            progressField.classList.remove('hidden');
            progressInput.value = progress;
            progressValue.textContent = `${progress}%`;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Close on click outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });
    </script>
</body>

</html>