<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project.name }} | aiD_PM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .sidebar-item-active {
            border-right: 4px solid #3b82f6;
            background: #1e293b;
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-100 font-sans h-screen overflow-hidden">
    <div class="flex h-full">
        <!-- Sidebar -->
        <aside class="w-64 bg-slate-950 text-slate-400 flex flex-col border-r border-slate-800">
            <div class="p-6 text-white font-bold text-xl tracking-tight border-b border-slate-800">
                aiD_PM <span class="text-blue-500">System</span>
            </div>
            <nav class="flex-1 mt-4 overflow-y-auto">
                <a href="/"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Dashboard</a>
                <a href="/projects/list"
                    class="flex items-center px-6 py-3 sidebar-item-active text-white hover:bg-slate-900 hover:text-white transition">Projects</a>
                <a href="/kanban"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Kanban</a>
                <a href="/tracking"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Tracking</a>
                <a href="/calendar-grid"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Calendar</a>

                <div class="px-6 py-2 mt-4 mb-2 border-t border-slate-700"></div>
                <a href="/management-control"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Control
                    Center</a>
                <a href="/phases"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Phases</a>
                <a href="/functions"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Functions/Req</a>
                <a href="/issues"
                    class="flex items-center px-6 py-3 hover:bg-slate-900 hover:text-white transition">Issues</a>
            </nav>
            <div class="p-4 border-t border-slate-800 text-xs text-slate-500 text-center">
                v1.5 AI Powered
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-8 bg-slate-50 min-h-full">
            <!-- Breadcrumb -->
            <div class="flex items-center gap-2 text-sm mb-6">
                <a href="/" class="text-blue-600 hover:underline">Dashboard</a>
                <span class="text-slate-400">‚Üí</span>
                <a href="/projects/list" class="text-blue-600 hover:underline">Projects</a>
                <span class="text-slate-400">‚Üí</span>
                <span class="text-slate-600 font-bold">{{ project.name }}</span>
            </div>

            <!-- Header -->
            <div class="flex justify-between items-start mb-8">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <h1 class="text-3xl font-bold text-slate-800">{{ project.name }}</h1>
                        {% if project.is_recovery_mode %}
                        <span class="px-3 py-1 bg-red-600 text-white rounded-lg text-sm font-bold">‚ö†Ô∏è RECOVERY
                            MODE</span>
                        {% else %}
                        <span class="px-3 py-1 bg-green-600 text-white rounded-lg text-sm font-bold">‚úì ACTIVE</span>
                        {% endif %}
                    </div>
                    {% if project.customer %}
                    <p class="text-slate-600">Customer: <span class="font-semibold">{{ project.customer }}</span></p>
                    {% else %}
                    <p class="text-slate-500 italic">Internal Project</p>
                    {% endif %}
                </div>
                <div class="flex gap-2">
                    <a href="/tasks/create?project_id={{ project.id }}"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition">
                        + Add Task
                    </a>
                    <a href="/gantt?project_id={{ project.id }}"
                        class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition">
                        üìä View Gantt
                    </a>
                    <a href="/export/weekly/{{ project.id }}"
                        class="px-4 py-2 bg-slate-700 hover:bg-slate-900 text-white rounded-lg font-medium transition">
                        Export Weekly
                    </a>
                    <a href="/export/daily/{{ project.id }}"
                        class="px-4 py-2 bg-slate-700 hover:bg-slate-900 text-white rounded-lg font-medium transition">
                        Export Daily
                    </a>
                    <a href="/projects/{{ project.id }}/history"
                        class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 border border-slate-300 rounded-lg font-medium transition">
                        üìú History
                    </a>
                </div>
            </div>

            <!-- Project Info Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <div class="text-slate-500 text-xs font-bold uppercase mb-1">Methodology</div>
                    <div class="text-2xl font-bold text-blue-600">{{ project.methodology }}</div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <div class="text-slate-500 text-xs font-bold uppercase mb-1">Total Tasks</div>
                    <div class="text-2xl font-bold">{{ tasks|length }}</div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm border-l-4 border-green-500">
                    <div class="text-slate-500 text-xs font-bold uppercase mb-1">Completed</div>
                    <div class="text-2xl font-bold text-green-600">
                        {{ tasks|selectattr('actual_progress', 'equalto', 100.0)|list|length }}
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <div class="text-slate-500 text-xs font-bold uppercase mb-1">Overall Progress</div>
                    <div class="text-2xl font-bold text-blue-600">{{ overall_progress|round(1) }}%</div>
                </div>
            </div>

            <!-- Overall Progress Bar -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 mb-8">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-slate-800">Project Progress (Value-Based)</h3>
                    <span class="text-sm text-slate-600">{{ overall_progress|round(1) }}% Complete</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-4">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-4 rounded-full transition-all duration-500"
                        style="width: {{ overall_progress }}%"></div>
                </div>
                <p class="text-xs text-slate-500 mt-2">Calculated from task weight scores</p>
            </div>

            <!-- Requirement Progress Summary -->
            {% if functions %}
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-slate-800 text-xl">üß© Requirement Progress</h3>
                    <a href="/functions?project_id={{ project.id }}"
                        class="text-sm text-blue-600 hover:text-blue-800 font-medium">Full Requirement View ‚Üí</a>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% for func in functions if not func.parent_function_id %}
                    <div class="border border-slate-100 rounded-lg p-4 bg-slate-50">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <span class="text-[10px] font-mono font-bold text-slate-400 block mb-1">{{
                                    func.function_code }}</span>
                                <h4 class="font-bold text-slate-800 text-sm">{{ func.function_name }}</h4>
                            </div>
                            <span class="px-2 py-0.5 rounded text-[10px] uppercase font-bold
                                {% if func.status == 'completed' %}bg-green-100 text-green-700
                                {% elif func.status == 'in_progress' %}bg-yellow-100 text-yellow-700
                                {% else %}bg-slate-200 text-slate-600{% endif %}">
                                {{ func.status.replace('_', ' ') }}
                            </span>
                        </div>

                        {% set linked_tasks = func.tasks %}
                        {% set total_tasks = linked_tasks|length %}
                        {% if total_tasks > 0 %}
                        {% set total_progress = 0 %}
                        {% for t in linked_tasks %}{% set total_progress = total_progress + t.actual_progress %}{%
                        endfor %}
                        {% set avg_p = (total_progress / total_tasks)|round %}
                        {% set total_est = linked_tasks|sum(attribute='estimated_hours') %}
                        {% set total_act = linked_tasks|sum(attribute='actual_hours') %}
                        {% else %}
                        {% set avg_p = 100 if func.status == 'completed' else 0 %}
                        {% set total_est = func.estimated_hours %}
                        {% set total_act = func.actual_hours %}
                        {% endif %}

                        <div class="space-y-3">
                            <div class="w-full bg-slate-200 rounded-full h-1.5">
                                <div class="bg-blue-600 h-1.5 rounded-full" style="width: {{ avg_p }}%"></div>
                            </div>
                            <div class="flex justify-between text-[10px] text-slate-500 font-bold uppercase">
                                <span>{{ avg_p }}% Complete</span>
                                <span>{{ "%.1f"|format(total_est) }}h / {{ "%.1f"|format(total_act) }}h</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Phase Timeline -->
            {% if phases %}
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-slate-800 text-xl">üìÖ Project Timeline - Gantt View</h3>
                    <div class="flex gap-2">
                        <button onclick="toggleWeeklyView()" id="weeklyToggle"
                            class="text-sm bg-blue-100 text-blue-700 hover:bg-blue-200 px-3 py-1 rounded-lg font-medium transition">
                            üìä Weekly Details
                        </button>
                        <a href="/phases?project_id={{ project.id }}"
                            class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                            Manage Phases ‚Üí
                        </a>
                    </div>
                </div>

                <!-- Professional Timeline View -->
                <div id="mainTimeline" class="relative w-full overflow-x-auto">
                    <div class="min-w-[1200px] border border-slate-300">
                        {% set total_days = (timeline_end - timeline_start).days %}
                        {% set total_months = (total_days / 30)|round(0, 'ceil')|int %}

                        <!-- Date Header Row -->
                        <div class="bg-slate-100 border-b border-slate-300">
                            <div class="flex">
                                <div
                                    class="w-48 bg-slate-200 border-r border-slate-300 p-2 flex items-center justify-center text-[10px] uppercase font-bold text-slate-500">
                                    Timeline
                                </div>
                                <div class="flex-1 flex text-center text-xs font-bold text-slate-700">
                                    {% for m in months_data %}
                                    <div class="p-2 border-r border-slate-300 last:border-r-0 overflow-hidden"
                                        style="width: {{ m.width_pct }}%;">
                                        <div class="font-bold truncate">{{ m.name }}</div>
                                        <div class="text-slate-500 text-[10px]">{{ m.year }}</div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Week Indicators (Auto-Calculated) -->
                        <div class="bg-slate-50 border-b border-slate-300">
                            <div class="flex">
                                <div class="w-48 border-r border-slate-200 bg-slate-50"></div>
                                <div class="flex-1 flex text-center text-[10px] text-slate-400">
                                    {% set total_weeks = (total_days / 7)|round(0, 'ceil')|int %}
                                    {% for w in range(1, total_weeks + 1) %}
                                    <div class="p-0.5 border-r border-slate-200 last:border-r-0"
                                        style="width: {{ (7 / total_days * 100) }}%;">
                                        W{{ w }}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Project Row -->
                        <div class="border-b border-slate-300">
                            <div class="flex">
                                <!-- Project Name Column -->
                                <div
                                    class="w-48 bg-slate-50 border-r border-slate-300 p-3 flex items-center font-bold text-slate-800">
                                    {{ project.name }}
                                </div>

                                <!-- Timeline Grid -->
                                <div class="flex-1 relative bg-white" style="height: 60px;">
                                    <!-- Grid Lines (Month Borders) -->
                                    <div class="absolute inset-0 flex">
                                        {% for m in months_data %}
                                        <div class="border-r border-slate-200 last:border-r-0 h-full"
                                            style="width: {{ m.width_pct }}%;"></div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Phase Rows -->
                        {% for phase in phases %}
                        {% if phase.planned_start and phase.planned_end %}
                        {% set start_offset = (phase.planned_start - timeline_start).days %}
                        {% set duration = (phase.planned_end - phase.planned_start).days %}
                        {% set left_pct = (start_offset / total_days * 100) %}
                        {% set width_pct = (duration / total_days * 100) %}

                        <div class="border-b border-slate-300 hover:bg-slate-50 transition-colors">
                            <div class="flex">
                                <!-- Phase Name Column -->
                                <div class="w-48 bg-slate-50 border-r border-slate-300 p-3 flex items-center">
                                    <div>
                                        <div class="font-semibold text-slate-800">{{ phase.phase_name }}</div>
                                        <div class="text-xs text-slate-500">
                                            {{ phase.planned_start.strftime('%d %b') }} - {{
                                            phase.planned_end.strftime('%d %b') }}
                                        </div>
                                    </div>
                                </div>

                                <!-- Timeline Grid -->
                                <div class="flex-1 relative bg-white" style="height: 50px;">
                                    <!-- Grid Lines (Month Borders) -->
                                    <div class="absolute inset-0 flex opacity-30">
                                        {% for m in months_data %}
                                        <div class="border-r border-slate-200 last:border-r-0 h-full"
                                            style="width: {{ m.width_pct }}%;"></div>
                                        {% endfor %}
                                    </div>

                                    <!-- Phase Bar -->
                                    <div class="absolute top-1/2 transform -translate-y-1/2 h-6 rounded shadow-sm cursor-pointer transition-all hover:shadow-md
                                              {% if phase.is_recovery_mode %}bg-red-400 hover:bg-red-500{% else %}bg-blue-400 hover:bg-blue-500{% endif %}"
                                        style="left: {{ left_pct }}%; width: {{ width_pct }}%; min-width: 20px"
                                        onclick="showPhaseDetails('{{ phase.phase_name }}', '{{ phase.planned_start.strftime('%d %b %Y') }}', '{{ phase.planned_end.strftime('%d %b %Y') }}', {{ duration }})">
                                        <div class="flex items-center h-full px-2">
                                            <span class="text-xs font-semibold text-white truncate">
                                                {{ phase.phase_name }}
                                            </span>
                                            {% if phase.is_recovery_mode %}
                                            <span class="ml-auto text-white">‚ö†Ô∏è</span>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Start Milestone -->
                                    <div class="absolute top-1/2 transform -translate-y-1/2 -translate-x-1/2"
                                        style="left: {{ left_pct }}%">
                                        <div
                                            class="w-0 h-0 border-l-4 border-r-4 border-b-6 border-l-transparent border-r-transparent 
                                                  {% if phase.is_recovery_mode %}border-b-red-600{% else %}border-b-green-600{% endif %}">
                                        </div>
                                    </div>

                                    <!-- End Milestone -->
                                    <div class="absolute top-1/2 transform -translate-y-1/2 translate-x-1/2"
                                        style="left: {{ left_pct + width_pct }}%">
                                        <div
                                            class="w-0 h-0 border-l-4 border-r-4 border-b-6 border-l-transparent border-r-transparent 
                                                  {% if phase.is_recovery_mode %}border-b-red-600{% else %}border-b-blue-600{% endif %}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>

                    <!-- Dynamic TODAY Marker - Full Height -->
                    <div id="todayMarker" class="absolute top-0 bg-green-500 opacity-80 z-30"
                        style="width: 2px; height: 100%; display: none;">
                        <div
                            class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-green-500 text-white text-xs px-2 py-1 rounded font-bold whitespace-nowrap">
                            TODAY
                        </div>
                    </div>
                </div>

                <!-- Weekly Breakdown View (Hidden by default) -->
                <div id="weeklyTimeline" class="hidden mt-8 border-t pt-6">
                    <h4 class="font-bold text-slate-700 mb-4 text-lg">üìä Weekly Breakdown View</h4>
                    <div class="bg-slate-50 rounded-lg p-4 overflow-x-auto">
                        <div class="min-w-[1400px]">
                            <!-- Week Headers -->
                            <div class="grid grid-cols-12 gap-2 mb-4 text-xs font-bold text-slate-600 uppercase">
                                {% for week_num in range(1, 13) %}
                                <div class="text-center p-2 bg-white rounded border">Week {{ week_num }}</div>
                                {% endfor %}
                            </div>

                            <!-- Phase Weekly Distribution -->
                            {% for phase in phases %}
                            {% if phase.planned_start and phase.planned_end %}
                            {% set phase_duration_weeks = ((phase.planned_end - phase.planned_start).days / 7)|round(0,
                            'ceil')|int %}
                            {% set start_week = ((phase.planned_start - timeline_start).days / 7)|round(0, 'floor')|int
                            + 1 %}

                            <div class="mb-4">
                                <div class="text-sm font-bold text-slate-700 mb-2">{{ phase.phase_name }}</div>
                                <div class="grid grid-cols-12 gap-2">
                                    {% for week_num in range(1, 13) %}
                                    <div class="h-8 rounded flex items-center justify-center text-xs font-medium
                                              {% if week_num >= start_week and week_num < start_week + phase_duration_weeks %}
                                                  {% if phase.is_recovery_mode %}bg-red-200 text-red-800 border border-red-300{% else %}bg-blue-200 text-blue-800 border border-blue-300{% endif %}
                                              {% else %}
                                                  bg-slate-100 text-slate-400
                                              {% endif %}">
                                        {% if week_num >= start_week and week_num < start_week + phase_duration_weeks %}
                                            W{{ week_num - start_week + 1 }} {% else %} ‚Äî {% endif %} </div>
                                            {% endfor %}
                                    </div>
                                    <div class="text-xs text-slate-500 mt-1 pl-2">
                                        Duration: {{ phase_duration_weeks }} weeks ‚Ä¢
                                        Start: Week {{ start_week }} ‚Ä¢
                                        Dates: {{ phase.planned_start.strftime('%d %b') }} - {{
                                        phase.planned_end.strftime('%d %b') }}
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}

                                <!-- Weekly Statistics -->
                                <div class="mt-6 bg-white rounded-lg p-4 border border-slate-200">
                                    <h5 class="font-bold text-slate-700 mb-3">üìà Weekly Statistics</h5>
                                    <div class="grid grid-cols-12 gap-2">
                                        {% for week_num in range(1, 13) %}
                                        <div
                                            class="text-center p-2 rounded bg-green-100 text-green-800 border border-green-200">
                                            <div class="text-xs font-bold">{{ loop.index }}</div>
                                            <div class="text-xs">week</div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="text-xs text-slate-500 mt-2">
                                        <span class="text-green-700">‚ñ† Low Load (1 phase)</span> ‚Ä¢
                                        <span class="text-yellow-700">‚ñ† Medium Load (2 phases)</span> ‚Ä¢
                                        <span class="text-red-700">‚ñ† High Load (3+ phases)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-8 text-center mb-8">
                        <div class="text-4xl mb-3">üìÖ</div>
                        <p class="text-slate-600 mb-4">No phases defined for this project yet</p>
                        <a href="/phases?project_id={{ project.id }}"
                            class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition">
                            + Create First Phase
                        </a>
                    </div>
                    {% endif %}

                    <!-- Project Metadata -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 mb-8">
                        <h3 class="font-bold text-slate-800 mb-4">Project Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div class="border-l-4 border-green-500 pl-4">
                                <p class="text-xs text-slate-500 uppercase font-bold">Progress</p>
                                <p class="text-lg font-bold text-slate-800">{{ overall_progress|round(1) }}%</p>
                            </div>
                            <div class="border-l-4 border-blue-500 pl-4">
                                <p class="text-xs text-slate-500 uppercase font-bold">Created</p>
                                <p class="text-lg font-bold text-slate-800">{{
                                    project.created_at.strftime('%Y-%m-%d') }}</p>
                            </div>
                            <div class="border-l-4 border-purple-500 pl-4">
                                <p class="text-xs text-slate-500 uppercase font-bold">Snapshots</p>
                                <p class="text-lg font-bold text-slate-800">{{ snapshots|length }} weeks</p>
                            </div>
                            <div class="border-l-4 border-orange-500 pl-4">
                                <p class="text-xs text-slate-500 uppercase font-bold">Project ID</p>
                                <p class="text-sm font-bold text-slate-800">#{{ project.id }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tasks Management -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-8">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-bold text-slate-800">Project Tasks</h3>
                            <div class="flex gap-3">
                                <button onclick="showImportModal()"
                                    class="text-sm text-green-600 hover:text-green-800 font-medium">
                                    Import CSV ‚Üë
                                </button>
                                <a href="/projects/{{ project.id }}/export-csv"
                                    class="text-sm text-purple-600 hover:text-purple-800 font-medium">
                                    Export CSV ‚Üì
                                </a>
                                <a href="/tasks/create?project_id={{ project.id }}"
                                    class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                                    + Add Task
                                </a>
                            </div>
                        </div>
                        {% if tasks %}
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold">
                                    <tr>
                                        <th class="px-6 py-3">Task ID</th>
                                        <th class="px-6 py-3">Task</th>
                                        <th class="px-6 py-3">Type</th>
                                        <th class="px-6 py-3">Weight</th>
                                        <th class="px-6 py-3">Start</th>
                                        <th class="px-6 py-3">End</th>
                                        <th class="px-6 py-3">Phase</th>
                                        <th class="px-6 py-3">Resource</th>
                                        <th class="px-6 py-3">Progress</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    {% for task in tasks %}
                                    <tr class="hover:bg-slate-50 transition">
                                        <td class="px-6 py-4">
                                            <span
                                                class="font-mono text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded font-bold">
                                                {{ task.task_id or 'GEN' + '%03d'|format(task.id) }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 font-medium text-slate-900">{{ task.task_name }}</td>
                                        <td class="px-6 py-4">
                                            <span
                                                class="px-2 py-1 bg-slate-100 text-slate-700 rounded text-xs font-bold">
                                                {{ task.task_type }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-slate-600">{{ task.weight_score }}</td>
                                        <td class="px-6 py-4 text-sm text-slate-600">
                                            {{ task.planned_start.strftime('%m/%d') if task.planned_start else '-' }}
                                        </td>
                                        <td class="px-6 py-4 text-sm text-slate-600">
                                            {{ task.planned_end.strftime('%m/%d') if task.planned_end else '-' }}
                                        </td>
                                        <td class="px-6 py-4 text-sm text-slate-600">
                                            {% if task.phase %}
                                            <span
                                                class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-medium">
                                                {{ task.phase.phase_name }}
                                            </span>
                                            {% else %}
                                            <span class="text-slate-400 text-xs">No Phase</span>
                                            {% endif %}
                                        </td>
                                        <td class="px-6 py-4 text-sm text-slate-600">
                                            {% if task.assigned_resource_id %}
                                            <span class="text-blue-600 font-semibold">
                                                Resource #{{ task.assigned_resource_id }}
                                            </span>
                                            {% else %}
                                            <span class="text-xs text-slate-400">Unassigned</span>
                                            {% endif %}
                                        </td>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex items-center gap-2">
                                                <div class="flex-1 bg-slate-100 rounded-full h-2 w-24">
                                                    <div class="{% if task.actual_progress == 100 %}bg-green-500{% elif task.actual_progress >= 50 %}bg-blue-500{% else %}bg-yellow-500{% endif %} h-2 rounded-full"
                                                        style="width: {{ task.actual_progress }}%"></div>
                                                </div>
                                                <a href="/tasks/{{ task.id }}/edit"
                                                    class="inline-flex items-center px-3 py-1 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded text-xs font-semibold transition">
                                                    Edit
                                                </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="p-12 text-center">
                            <div class="text-4xl mb-3">üìã</div>
                            <p class="text-slate-600 mb-4">No tasks in this project yet</p>
                            <a href="/tasks/create?project_id={{ project.id }}"
                                class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition">
                                + Add First Task
                            </a>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Weekly Snapshots -->
                    {% if snapshots %}
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 mt-8">
                        <h3 class="font-bold text-slate-800 mb-4">Weekly Snapshots (PB Curve Data)</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse text-sm">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="px-4 py-2 font-bold text-slate-700">Week</th>
                                        <th class="px-4 py-2 font-bold text-slate-700">Plan %</th>
                                        <th class="px-4 py-2 font-bold text-slate-700">Actual %</th>
                                        <th class="px-4 py-2 font-bold text-slate-700">Variance</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    {% for snapshot in snapshots %}
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-4 py-2 font-semibold text-slate-800">Week {{
                                            snapshot.week_number }}</td>
                                        <td class="px-4 py-2 text-slate-800">{{ snapshot.plan_acc|round(1) }}%</td>
                                        <td class="px-4 py-2 text-slate-800">{{ snapshot.actual_acc|round(1) }}%
                                        </td>
                                        <td class="px-4 py-2">
                                            {% set variance = snapshot.actual_acc - snapshot.plan_acc %}
                                            <span
                                                class="{% if variance >= 0 %}text-green-600{% else %}text-red-600{% endif %} font-bold">
                                                {{ variance|round(1) }}%
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Issues Management -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mt-8">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-bold text-slate-800">Project Issues</h3>
                            <a href="/issues?project_id={{ project.id }}"
                                class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                                Manage Issues ‚Üí
                            </a>
                        </div>
                        {% if issues %}
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold">
                                    <tr>
                                        <th class="px-6 py-3">Status</th>
                                        <th class="px-6 py-3">Priority</th>
                                        <th class="px-6 py-3">Description</th>
                                        <th class="px-6 py-3">Owner</th>
                                        <th class="px-6 py-3">Due Date</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    {% for issue in issues %}
                                    <tr class="hover:bg-slate-50 transition">
                                        <td class="px-6 py-4">
                                            <span class="px-2 py-1 rounded text-xs font-bold
                                        {% if issue.status == 'Open' %}bg-red-100 text-red-700
                                        {% elif issue.status == 'In Progress' %}bg-yellow-100 text-yellow-700
                                        {% else %}bg-green-100 text-green-700{% endif %}">
                                                {{ issue.status }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <span class="px-2 py-1 rounded text-xs font-bold
                                        {% if issue.priority == 'High' %}bg-red-50 text-red-600
                                        {% elif issue.priority == 'Medium' %}bg-orange-50 text-orange-600
                                        {% else %}bg-slate-100 text-slate-600{% endif %}">
                                                {{ issue.priority }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-slate-700 max-w-xs truncate">
                                            {{ issue.issue_description }}
                                        </td>
                                        <td class="px-6 py-4 text-sm text-slate-600">
                                            {% if issue.pic_resource_id %}Resource #{{ issue.pic_resource_id }}{%
                                            else %}-{%
                                            endif %}
                                        </td>
                                        <td class="px-6 py-4 text-sm text-slate-600">
                                            {{ issue.due_date.strftime('%Y/%m/%d') if issue.due_date else '-' }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="p-8 text-center">
                            <p class="text-slate-500 mb-4">No issues reported for this project</p>
                            <a href="/issues/create?project_id={{ project.id }}"
                                class="inline-block bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg font-medium transition">
                                + Report Issue
                            </a>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Quick Actions -->
                    <div class="mt-8 flex gap-3">
                        <button onclick="window.location.href='/daily-tracking?project_id={{ project.id }}'"
                            class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium transition">
                            Go to Daily Tracking
                        </button>
                        <button onclick="takeSnapshot()"
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition">
                            Take Weekly Snapshot
                        </button>
                    </div>
        </main>
    </div>

    <!-- Import CSV Modal -->
    <div id="importModal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800">Import Tasks from CSV</h3>
                <button onclick="hideImportModal()" class="text-slate-400 hover:text-slate-600">‚úï</button>
            </div>

            <form id="importForm" onsubmit="handleImport(event)" class="space-y-4">
                <div class="p-4 bg-blue-50 rounded-lg border border-blue-100 text-sm text-blue-800">
                    <p class="font-bold mb-1">‚ÑπÔ∏è Instructions:</p>
                    <ul class="list-disc list-inside space-y-1 text-xs">
                        <li>Use the "Export CSV" file as a template</li>
                        <li>Existing Task IDs will be updated</li>
                        <li>New Task IDs (or empty) will create new tasks</li>
                        <li>Dates must be in YYYYMMDD format</li>
                    </ul>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Select CSV File</label>
                    <input type="file" id="csvFile" accept=".csv" required
                        class="w-full border border-slate-300 rounded-lg px-4 py-2 text-sm text-slate-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>

                <div id="importResult" class="hidden p-4 rounded-lg text-sm"></div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="hideImportModal()"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg font-medium transition">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition">
                        Upload & Import
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function showImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
            document.getElementById('importModal').classList.add('flex');
        }

        function hideImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            document.getElementById('importModal').classList.remove('flex');
            document.getElementById('importResult').classList.add('hidden');
            document.getElementById('importForm').reset();
        }

        async function handleImport(event) {
            event.preventDefault();
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            const resultDiv = document.getElementById('importResult');
            resultDiv.classList.remove('hidden');
            resultDiv.className = 'p-4 rounded-lg text-sm bg-slate-100 text-slate-600';
            resultDiv.textContent = 'Uploading and processing...';

            try {
                const response = await fetch('/projects/{{ project.id }}/tasks/import', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.status === 'success' && data.success) {
                        resultDiv.className = 'p-4 rounded-lg text-sm bg-green-50 text-green-800 border border-green-200';
                        resultDiv.innerHTML = `
                            <p class="font-bold">‚úÖ Import Successful!</p>
                            <ul class="list-disc list-inside mt-1">
                                <li>Created: ${data.created_count || 0}</li>
                                <li>Updated: ${data.updated_count || 0}</li>
                            </ul>
                        `;
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        resultDiv.className = 'p-4 rounded-lg text-sm bg-red-50 text-red-800 border border-red-200';
                        resultDiv.innerHTML = `<p class="font-bold">‚ùå Import Failed:</p><p>${data.message || 'Unknown error'}</p>`;
                        if (data.errors && data.errors.length > 0) {
                            resultDiv.innerHTML += `<ul class="list-disc list-inside mt-1 max-h-32 overflow-y-auto">${data.errors.map(e => `<li>${e}</li>`).join('')}</ul>`;
                        }
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || errorData.detail || 'Import failed');
                }
            } catch (error) {
                resultDiv.className = 'p-4 rounded-lg text-sm bg-red-50 text-red-800 border border-red-200';
                resultDiv.textContent = `Error: ${error.message}`;
            }
        }

        async function takeSnapshot() {
            if (confirm('Take weekly snapshot for this project?')) {
                try {
                    const response = await fetch('/projects/{{ project.id }}/take-snapshot', {
                        method: 'POST'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        alert(`Snapshot recorded! Actual progress: ${data.actual_acc.toFixed(2)}%`);
                        location.reload();
                    } else {
                        alert('Failed to take snapshot');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error taking snapshot');
                }
            }
        }

        // Toggle Weekly Timeline View
        function toggleWeeklyView() {
            const weeklyTimeline = document.getElementById('weeklyTimeline');
            const toggleButton = document.getElementById('weeklyToggle');

            if (weeklyTimeline.classList.contains('hidden')) {
                weeklyTimeline.classList.remove('hidden');
                weeklyTimeline.scrollIntoView({ behavior: 'smooth', block: 'start' });
                toggleButton.innerHTML = 'üìä Hide Weekly Details';
                toggleButton.classList.remove('bg-blue-100', 'text-blue-700');
                toggleButton.classList.add('bg-slate-200', 'text-slate-700');
            } else {
                weeklyTimeline.classList.add('hidden');
                toggleButton.innerHTML = 'üìä Weekly Details';
                toggleButton.classList.remove('bg-slate-200', 'text-slate-700');
                toggleButton.classList.add('bg-blue-100', 'text-blue-700');
            }
        }

        // Show Phase Details Modal
        function showPhaseDetails(phaseName, startDate, endDate, duration) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('phaseDetailsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'phaseDetailsModal';
                modal.className = 'fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6 mx-4">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-bold text-slate-800">üìÖ Phase Details</h4>
                            <button onclick="closePhaseDetails()" class="text-slate-400 hover:text-slate-600 text-xl">‚úï</button>
                        </div>
                        <div id="phaseDetailsContent" class="space-y-4">
                            <!-- Content will be populated here -->
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button onclick="closePhaseDetails()" 
                                class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg font-medium transition">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Populate modal content
            const content = document.getElementById('phaseDetailsContent');
            const weekDuration = Math.ceil(duration / 7);
            content.innerHTML = `
                <div class="border-l-4 border-blue-500 pl-4 bg-blue-50 rounded-r-lg p-4">
                    <h5 class="font-bold text-blue-800 text-lg">${phaseName}</h5>
                    <div class="mt-3 space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-600">Start Date:</span>
                            <span class="font-medium text-slate-800">${startDate}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">End Date:</span>
                            <span class="font-medium text-slate-800">${endDate}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">Duration:</span>
                            <span class="font-medium text-slate-800">${duration} days (${weekDuration} weeks)</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">Phase Type:</span>
                            <span class="font-medium text-slate-800">Standard Phase</span>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-50 rounded-lg p-4">
                    <h6 class="font-bold text-slate-700 mb-2">üìä Weekly Breakdown</h6>
                    <div class="grid grid-cols-7 gap-1 text-xs">
                        ${Array.from({ length: weekDuration }, (_, i) =>
                `<div class="text-center p-1 bg-blue-100 text-blue-800 rounded border">W${i + 1}</div>`
            ).join('')}
                    </div>
                    <div class="text-xs text-slate-500 mt-2">
                        This phase spans ${weekDuration} week${weekDuration > 1 ? 's' : ''} of project timeline
                    </div>
                </div>
            `;

            // Show modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Close Phase Details Modal
        function closePhaseDetails() {
            const modal = document.getElementById('phaseDetailsModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function (event) {
            const modal = document.getElementById('phaseDetailsModal');
            if (modal && event.target === modal) {
                closePhaseDetails();
            }
        });

        // Calculate and display TODAY marker
        function initTodayMarker() {
            const todayMarker = document.getElementById('todayMarker');
            if (!todayMarker) return;

            // Get timeline dates from template variables
            const timelineStart = new Date('{{ timeline_start.strftime("%Y-%m-%d") }}');
            const timelineEnd = new Date('{{ timeline_end.strftime("%Y-%m-%d") }}');
            const today = new Date();

            // Check if today is within the timeline range
            if (today >= timelineStart && today <= timelineEnd) {
                // Calculate position as percentage
                const totalDays = Math.ceil((timelineEnd - timelineStart) / (1000 * 60 * 60 * 24));
                const daysPassed = Math.ceil((today - timelineStart) / (1000 * 60 * 60 * 24));
                const todayPosition = (daysPassed / totalDays) * 100;

                // Position and show the marker
                todayMarker.style.left = todayPosition + '%';
                todayMarker.style.display = 'block';

                console.log(`TODAY marker positioned at ${todayPosition.toFixed(2)}% (Day ${daysPassed} of ${totalDays})`);
            } else {
                console.log('Today is outside the project timeline range');
            }
        }

        // Initialize TODAY marker when page loads
        document.addEventListener('DOMContentLoaded', initTodayMarker);
    </script>
</body>

</html>